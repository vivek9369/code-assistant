<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Code Explainer & Debugger</title>
    <!-- Load Tailwind CSS from CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="style.css">
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #eef2ff; /* Light Lavender background for the page */
        }
        /* Custom scrollbar for better aesthetics */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #818cf8; /* indigo-400 */
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background-color: #f1f5f9; /* slate-100 */
        }
        textarea, #output-panel {
            min-height: 400px;
            transition: box-shadow 0.3s ease;
        }
        /* Enhanced styling for the output panel content (Markdown rendering) */
        #output-panel pre {
            background-color: #f3f4f6; /* gray-100 */
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin-top: 1rem;
            margin-bottom: 1rem;
            border: 1px solid #e5e7eb;
        }
        #output-panel code {
            font-family: 'SF Mono', 'Roboto Mono', monospace;
            font-size: 0.875rem;
            color: #1f2937; /* dark text for contrast */
        }
        #output-panel h1, #output-panel h2 {
            font-weight: 700;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            padding-bottom: 0.25rem;
            color: #1e3a8a; /* Blue-900 for headings */
            border-bottom: 2px solid #e0e7ff; /* light indigo separator */
        }
        #output-panel ul {
            list-style-type: disc;
            padding-left: 1.5rem;
            margin-top: 0.5rem;
            margin-bottom: 1rem;
        }
        #output-panel li {
            margin-bottom: 0.25rem;
        }
    </style>
</head>
<body class="p-4 md:p-10">

    <div class="max-w-7xl mx-auto bg-white shadow-2xl rounded-2xl overflow-hidden transform transition-all duration-300">
        
        <!-- Header -->
        <header class="bg-gradient-to-r from-indigo-700 to-purple-600 p-6 shadow-xl">
            <h1 class="text-3xl font-extrabold text-white flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-3 text-pink-300" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
                Code Assistant
            </h1>
            <p class="text-indigo-200 text-sm mt-1">Intelligent assistant for code explanation, debugging, and quality refactoring.</p>
        </header>

        <!-- Main Content Area: Side-by-Side View -->
        <main class="grid grid-cols-1 lg:grid-cols-2 gap-8 p-6 md:p-8">
            
            <!-- Left Panel: Input and Controls -->
            <section class="space-y-5">
                <h2 class="text-2xl font-bold text-gray-800 border-b border-gray-200 pb-2">Input & Configuration</h2>

                <!-- Control Panel -->
                <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                    
                    <!-- Language Selector -->
                    <select id="language-selector" class="flex-1 p-3 border border-indigo-300 rounded-xl shadow-md focus:ring-purple-500 focus:border-purple-500 text-gray-700 bg-white transition duration-150">
                        <option value="JavaScript">JavaScript</option>
                        <option value="Python">Python</option>
                        <option value="Java">Java</option>
                        <option value="TypeScript">TypeScript</option>
                        <option value="Go">Go</option>
                        <option value="C++">C++</option>
                        <option value="Rust">Rust</option>
                        <option value="General">General/Other</option>
                    </select>

                    <!-- Mode Selector -->
                    <select id="mode-selector" class="flex-1 p-3 border border-indigo-300 rounded-xl shadow-md focus:ring-purple-500 focus:border-purple-500 text-gray-700 bg-white transition duration-150">
                        <option value="explain">üìù Explain Code</option>
                        <option value="debug">üêõ Find & Fix Bug</option>
                        <option value="refactor">‚ú® Refactor/Improve</option>
                    </select>
                </div>
                
                <!-- Code Input Area -->
                <textarea id="code-input" placeholder="Paste your code snippet here..." class="w-full p-5 border border-gray-300 rounded-xl shadow-inner focus:border-purple-500 focus:ring-4 focus:ring-purple-100 text-sm font-mono bg-gray-50 resize-none transition duration-200"></textarea>

                <!-- Submit Button -->
                <button id="process-button" class="w-full bg-gradient-to-r from-indigo-500 to-purple-500 hover:from-indigo-600 hover:to-purple-600 text-white font-bold py-4 px-4 rounded-xl shadow-lg hover:shadow-xl transition duration-300 disabled:opacity-60 disabled:cursor-not-allowed flex items-center justify-center space-x-2">
                    <span id="button-text" class="text-lg">Analyze Code...</span>
                    <svg id="loading-spinner" class="animate-spin h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
            </section>

            <!-- Right Panel: Output and Results -->
            <section class="space-y-5">
                <h2 class="text-2xl font-bold text-gray-800 border-b border-gray-200 pb-2">Code Analysis</h2>
                
                <div id="output-panel" class="w-full p-5 border border-indigo-200 rounded-xl shadow-inner bg-white custom-scrollbar overflow-y-auto text-gray-800 transition duration-300">
                    <p class="text-gray-500 italic">Select a mode and paste your code to receive an expert analysis. The analysis will be formatted for optimal readability.</p>
                </div>

                <!-- Error Message Box -->
                <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-xl relative shadow-md" role="alert">
                    <strong class="font-bold">Execution Failed:</strong>
                    <span class="block sm:inline" id="error-text"></span>
                </div>
            </section>

        </main>
    </div>

    <script>
        // --- Gemini API Configuration ---
        // IMPORTANT: The API key has been hardcoded as requested by the user. 
        // In a real application, use environment variables for security.
        const providedApiKey = "Enter Your Gemini API Key Here"; //
        const apiKey = providedApiKey;
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        const MAX_RETRIES = 5;

        // --- DOM Elements ---
        const codeInput = document.getElementById('code-input');
        const languageSelector = document.getElementById('language-selector');
        const modeSelector = document.getElementById('mode-selector');
        const processButton = document.getElementById('process-button');
        const outputPanel = document.getElementById('output-panel');
        const loadingSpinner = document.getElementById('loading-spinner');
        const buttonText = document.getElementById('button-text');
        const errorMessage = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');

        // --- Helper Functions for Prompts ---

        const getSystemInstruction = (mode, language) => {
            switch (mode) {
                case 'explain':
                    return `You are a professional code explainer. Your task is to provide a comprehensive, step-by-step breakdown of the provided ${language} code snippet.`;
                case 'debug':
                    return `You are an expert debugger and static analysis tool. Your task is to rigorously analyze the provided ${language} code, identify any bugs, logical errors, or potential security vulnerabilities, and provide the definitive fix.`;
                case 'refactor':
                    return `You are a world-class software architect. Your task is to review and refactor the provided ${language} code snippet for modern practices, performance, readability, and maintainability.`;
                default:
                    return "You are a helpful coding assistant.";
            }
        };

        const getUserQuery = (mode, code) => {
            switch (mode) {
                case 'explain':
                    return `Provide a concise summary, followed by a detailed, line-by-line explanation of the following code. Format your entire response strictly in clean, runnable Markdown.
---
${code}`;
                case 'debug':
                    return `Identify the bug, explain the solution, and provide the complete, fixed code block (using markdown code fences) for the following snippet. Format your entire response strictly in clean, runnable Markdown.
---
${code}`;
                case 'refactor':
                    return `Suggest modern refactoring changes to the following code. Explain your reasoning and provide the complete, clean, refactored code block (using markdown code fences). Format your entire response strictly in clean, runnable Markdown.
---
${code}`;
                default:
                    return `Analyze the following code: ${code}`;
            }
        };

        /**
         * Renders Markdown content as proper HTML, focusing on reliability for code blocks, lists, and headings.
         * This function has been significantly improved for better visual output based on the user's feedback.
         * @param {string} markdownText - The Markdown text to render.
         */
        const renderMarkdown = (markdownText) => {
            // Normalize newline characters
            let htmlText = markdownText.replace(/\r\n/g, '\n').replace(/\r/g, '\n');

            // 1. Handle Code Blocks (must be done first to protect content)
            // Replace ```[lang]\ncode\n``` with <pre><code>...</code></pre>
            htmlText = htmlText.replace(/```(\w+)?\n([\s\S]*?)\n```/g, (match, lang, code) => {
                const language = lang || 'text';
                return `<pre><code class="language-${language}">${code.trim()}</code></pre>\n`;
            });

            // 2. Headings (H1 and H2 - the most common)
            htmlText = htmlText.replace(/^##\s*(.*)$/gm, '<h2>$1</h2>');
            htmlText = htmlText.replace(/^#\s*(.*)$/gm, '<h1>$1</h1>');

            // 3. Horizontal Rule
            htmlText = htmlText.replace(/^-{3,}$/gm, '<hr>');

            // 4. Strong/Bold
            htmlText = htmlText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            htmlText = htmlText.replace(/\*(.*?)\*/g, '<strong>$1</strong>');
            
            // 5. Unordered Lists (Must be done before paragraph wrapping)
            // Find list items starting with '*' or '-' at the start of a line (or after a newline)
            // Look for * or - followed by a space at the beginning of a line
            htmlText = htmlText.replace(/(^|\n)[\*\-]\s+(.*)$/gm, '$1<li>$2</li>');
            
            // Wrap consecutive <li> tags in <ul> tags
            htmlText = htmlText.replace(/(<li>[\s\S]*?<\/li>)/g, (match, content) => {
                if (content.trim().startsWith('<li>')) {
                    // Check if the previous content was NOT the end of a list
                    let before = htmlText.substring(0, htmlText.indexOf(match));
                    if (!before.trim().endsWith('</ul>') && !before.trim().endsWith('</li>') && !before.trim().endsWith('<br>')) {
                        return `<ul>${match}</ul>`;
                    }
                }
                return match;
            });

            // Second pass for lists, replacing contiguous list items
            htmlText = htmlText.replace(/<\/ul>\s*<ul>/g, '');


            // 6. Paragraphs and Line Breaks
            // Replace two or more consecutive newlines with a paragraph closer/opener.
            htmlText = htmlText.replace(/\n{2,}/g, '</p><p>');
            // Replace single newlines with a <br>
            htmlText = htmlText.replace(/\n/g, '<br>');

            // 7. Final cleanup and wrapping
            // Remove leading/trailing <br> tags.
            htmlText = htmlText.replace(/<br>$/, '').replace(/^<br>/, '');

            // Wrap non-block content in a starting paragraph tag
            if (!htmlText.startsWith('<h1>') && !htmlText.startsWith('<h2>') && !htmlText.startsWith('<pre>') && !htmlText.startsWith('<ul>') && htmlText.length > 0) {
                htmlText = `<p>${htmlText}`;
            }

            // Ensure we close any opened paragraph tag
            if (htmlText.includes('<p>') && !htmlText.endsWith('</p>') && !htmlText.endsWith('</ul>') && !htmlText.endsWith('</pre>')) {
                htmlText += '</p>';
            }

            // Final cleanup of extra tags
            htmlText = htmlText.replace(/<p><\/p>/g, '');
            htmlText = htmlText.replace(/<p><br>/g, '<p>');
            htmlText = htmlText.replace(/<br><\/p>/g, '</p>');
            
            // Set the final HTML
            outputPanel.innerHTML = htmlText.trim();
        };

        /**
         * Clears and displays an error message.
         * @param {string} message - The error message.
         */
        const showError = (message) => {
            errorText.textContent = message;
            errorMessage.classList.remove('hidden');
        };

        /**
         * Clears the error message.
         */
        const clearError = () => {
            errorMessage.classList.add('hidden');
            errorText.textContent = '';
        };

        /**
         * Calls the Gemini API with exponential backoff for resilience.
         * @param {object} payload - The request payload.
         * @param {number} attempt - Current retry attempt (starts at 1).
         * @returns {Promise<object>} The API response JSON.
         */
        async function callGeminiAPI(payload, attempt = 1) {
            if (!apiKey) {
                throw new Error("Gemini API key is not configured.");
            }

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    if (response.status === 429 && attempt < MAX_RETRIES) {
                        const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                        console.log(`Rate limit exceeded (429). Retrying in ${delay.toFixed(0)}ms (Attempt ${attempt + 1}/${MAX_RETRIES}).`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return callGeminiAPI(payload, attempt + 1); // Retry with next attempt number
                    }
                    const errorJson = await response.json();
                    throw new Error(`API Error: ${response.status} - ${errorJson.error?.message || response.statusText}`);
                }

                return response.json();

            } catch (error) {
                throw new Error(`Fetch failed: ${error.message}`);
            }
        }

        /**
         * Main function to handle user request and call the API.
         */
        async function processCode() {
            clearError();
            const code = codeInput.value.trim();
            const language = languageSelector.value;
            const mode = modeSelector.value;

            if (code.length < 10) {
                showError("Please paste a valid code snippet (at least 10 characters long).");
                return;
            }

            // UI State: Loading
            processButton.disabled = true;
            loadingSpinner.classList.remove('hidden');
            buttonText.textContent = mode === 'explain' ? 'Explaining...' : mode === 'debug' ? 'Debugging...' : 'Refactoring...';
            outputPanel.innerHTML = '<p class="text-indigo-600 italic animate-pulse">Analyzing code, please wait...</p>';

            try {
                const systemInstruction = getSystemInstruction(mode, language);
                const userQuery = getUserQuery(mode, code);

                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: { parts: [{ text: systemInstruction }] },
                };

                const result = await callGeminiAPI(payload);

                const generatedText = result?.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!generatedText) {
                    throw new Error("Gemini did not return a valid response. Check API usage or prompt.");
                }

                renderMarkdown(generatedText);

            } catch (error) {
                console.error("Gemini Code Assistant Error:", error);
                showError(error.message);
                outputPanel.innerHTML = `<p class="text-red-500 font-semibold">Failed to get analysis. Please check the console for details.</p>`;
            } finally {
                // UI State: Ready
                processButton.disabled = false;
                loadingSpinner.classList.add('hidden');
                buttonText.textContent = 'Analyze Code with Gemini';
            }
        }

        // --- Event Listener ---
        processButton.addEventListener('click', processCode);

        // Populate example code on load
        window.onload = () => {
            codeInput.value = `
function calculateTotal(items) {
    let total = 0;
    for (let i = 0; i <= items.length; i++) {
        total += items[i].price;
    }
    return total;
}
// Example call: calculateTotal([{price: 10}, {price: 20}])
            `.trim();
        };
    </script>
</body>
</html>
